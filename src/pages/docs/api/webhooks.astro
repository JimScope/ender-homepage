---
import DocsLayout from '../../../layouts/DocsLayout.astro'
import CodeBlock from '../../../components/CodeBlock.astro'
---

<DocsLayout title="Webhooks">
  <h1>Webhooks</h1>

  <p class="lead text-xl text-neutral-600">
    Receive real-time notifications for message events.
  </p>

  <h2>Setting up webhooks</h2>

  <p>Configure webhooks in the Dashboard → Settings → Webhooks. Each webhook configuration includes:</p>

  <ul>
    <li><strong>URL</strong> - The endpoint that will receive POST requests</li>
    <li><strong>Events</strong> - Which events to subscribe to</li>
    <li><strong>Secret</strong> - Used to sign payloads for verification (auto-generated, AES-encrypted at rest)</li>
  </ul>

  <h2>Event types</h2>

  <table>
    <thead>
      <tr>
        <th>Event</th>
        <th>Direction</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>sms_received</code></td>
        <td>Incoming</td>
        <td>An SMS was received by a device</td>
      </tr>
      <tr>
        <td><code>sms_sent</code></td>
        <td>Outgoing</td>
        <td>A device confirmed the SMS was sent</td>
      </tr>
      <tr>
        <td><code>sms_delivered</code></td>
        <td>Outgoing</td>
        <td>The carrier confirmed the SMS was delivered</td>
      </tr>
      <tr>
        <td><code>sms_failed</code></td>
        <td>Outgoing</td>
        <td>The SMS could not be sent or delivered</td>
      </tr>
    </tbody>
  </table>

  <h2>Webhook payloads</h2>

  <p>Ender sends a POST request with a JSON body. Keys are sorted alphabetically for deterministic HMAC signing. The payload fields depend on the event type.</p>

  <h3><code>sms_received</code></h3>

  <CodeBlock
    lang="json"
    code={`{
  "body": "Hello, this is a test message",
  "event": "sms_received",
  "from": "+1234567890",
  "message_id": "a1b2c3d4e5f6g7h",
  "timestamp": "2024-01-15 10:30:05.000Z"
}`}
  />

  <h3><code>sms_sent</code> / <code>sms_delivered</code></h3>

  <CodeBlock
    lang="json"
    code={`{
  "body": "Your verification code is 847293",
  "delivered_at": "2024-01-15 10:31:12.000Z",
  "event": "sms_delivered",
  "message_id": "a1b2c3d4e5f6g7h",
  "sent_at": "2024-01-15 10:30:08.000Z",
  "status": "delivered",
  "timestamp": "2024-01-15 10:30:05.000Z",
  "to": "+1234567890"
}`}
  />

  <h3><code>sms_failed</code></h3>

  <CodeBlock
    lang="json"
    code={`{
  "body": "Your verification code is 847293",
  "error_message": "FCM not initialized",
  "event": "sms_failed",
  "message_id": "a1b2c3d4e5f6g7h",
  "status": "failed",
  "timestamp": "2024-01-15 10:30:05.000Z",
  "to": "+1234567890"
}`}
  />

  <h2>Verifying webhooks</h2>

  <p>Webhooks include an HMAC-SHA256 signature in the <code>X-Webhook-Signature</code> header. The signature is computed over the entire JSON body using your webhook secret:</p>

  <CodeBlock lang="bash" code="X-Webhook-Signature: a1b2c3d4e5f6..." />

  <p>Verify it using your webhook secret:</p>

  <CodeBlock
    lang="python"
    code={`import hmac
import hashlib

def verify_signature(payload_bytes, signature, secret):
    """Verify the webhook signature.

    Important: Use the raw request body (not re-serialized JSON)
    since the signature is computed over sorted-key JSON.
    """
    expected = hmac.new(
        secret.encode(),
        payload_bytes,
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(expected, signature)`}
  />

  <CodeBlock
    lang="javascript"
    code={`import { createHmac } from "crypto";

function verifySignature(payloadBuffer, signature, secret) {
  const expected = createHmac("sha256", secret)
    .update(payloadBuffer)
    .digest("hex");
  return expected === signature;
}`}
  />

  <h2>Retry policy</h2>

  <p>Failed webhook deliveries are retried with exponential backoff:</p>

  <ul>
    <li>3 retries with increasing delays</li>
    <li>Webhook marked as failed after all retries are exhausted</li>
  </ul>

  <h2>Related</h2>

  <ul>
    <li><a href="/docs/api/send-sms">Send SMS</a> - Send messages</li>
    <li><a href="/docs/api/status">Message Status</a> - Poll for status</li>
  </ul>
</DocsLayout>
